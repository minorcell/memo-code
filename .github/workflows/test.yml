name: Test

on:
    push:
        branches: ['**']
    pull_request:
        branches: ['**']
    workflow_dispatch:

jobs:
    # 测试各个包 (Linux only, 快速反馈)
    test-packages:
        name: Test @memo/${{ matrix.package }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                package: [core, tools, cli]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1

            - name: Install ripgrep
              run: sudo apt-get update && sudo apt-get install -y ripgrep

            - name: Install dependencies
              run: bun install

            - name: Run tests
              run: bun run test:${{ matrix.package }}

    # 多平台集成测试
    test-integration:
        name: Integration (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1

            - name: Install ripgrep (Linux)
              if: runner.os == 'Linux'
              run: sudo apt-get update && sudo apt-get install -y ripgrep

            - name: Install ripgrep (macOS)
              if: runner.os == 'macOS'
              run: brew install ripgrep

            - name: Install ripgrep (Windows)
              if: runner.os == 'Windows'
              run: choco install ripgrep -y

            - name: Install dependencies
              run: bun install

            - name: Run all tests
              run: bun run test:all

            - name: Test build
              run: bun run build
